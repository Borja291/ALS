{% extends "layout.html" %} {# Hereda la plantilla base con cabecera, scripts y estilos comunes #}

{% block extra_body_class %}fondo-inicio{% endblock %} {# Clase adicional para el <body>, usada para aplicar un fondo espec√≠fico #}

{% block title %}Todas las pel√≠culas en CineMate{% endblock %} {# T√≠tulo que aparece en la pesta√±a del navegador #}

{% block content %} {# Comienzo del bloque de contenido principal de esta vista #}

<!-- Contenedor principal de la p√°gina -->
<div class="container">
    <div class="section">

        <!-- T√≠tulo de la secci√≥n -->
        <h1 class="mb-4 text-center">üåç Todas las Pel√≠culas</h1>

        <!-- Barra de b√∫squeda para filtrar pel√≠culas -->
        <div class="text-center mb-4">
            <input type="text" id="searchInput" class="form-control search-panel" placeholder="Buscar pel√≠cula...">
        </div>

        {% if movies %} {# Verifica si hay pel√≠culas para mostrar #}
        <div class="row" id="moviesContainer">
            {% for movie in movies %} {# Recorre todas las pel√≠culas disponibles #}

            <!-- Tarjeta individual para cada pel√≠cula -->
            <div class="col-md-6 col-lg-4 mb-4 movie-card" data-title="{{ movie.title|lower }}">
                <div class="card h-100 text-light black-background">
                    <div class="card-body d-flex flex-column">

                        <!-- T√≠tulo y a√±o de la pel√≠cula -->
                        <h5 class="card-title fw-bold">{{ movie.title }} ({{ movie.year }})</h5>

                        <!-- Subt√≠tulo con el usuario que la registr√≥ y el g√©nero -->
                        <h6 class="card-subtitle mb-2 text-muted-light">
                            Registrada por: {{
                                users_by_id[movie.original_user_id]
                                if movie.original_user_id in users_by_id
                                else users_by_id.get(movie.user_id, "Usuario desconocido")
                            }}<br>
                            G√©nero: {{ movie.genre }}
                        </h6>

                        {# Obtiene todas las rese√±as asociadas a la pel√≠cula #}
                        {% set all_reviews = reviews_by_movie[movie.original_movie_id] if movie.original_movie_id in reviews_by_movie else [] %}

                        {% if all_reviews %} {# Si hay rese√±as, se calculan y muestran #}
                        {% set ratings = all_reviews | map(attribute='rating') | map('int') | list %}

                        <!-- Muestra el promedio de puntuaciones y n√∫mero de rese√±as -->
                        <div class="mt-3">
                            ‚≠ê {{ ratings | sum / ratings | length | round(1) }}/5 ‚Äì {{ ratings | length }} rese√±a{{ 's' if ratings|length > 1 }}

                            <!-- Bot√≥n para mostrar/ocultar rese√±as -->
                            <button class="btn btn-primary btn-sm mt-2" id="btn-{{ movie.id }}"
                                onclick="toggleReviews('{{ movie.id }}')">
                                üëÅ Ver rese√±as
                            </button>

                            <!-- Lista de rese√±as ocultas/visibles -->
                            <div id="reviews-{{ movie.id }}" class="mt-3 review-explore">
                                {% for r in all_reviews %}
                                <p class="mb-2">
                                    <strong>{{ users_by_id.get(r.user_id, "Usuario desconocido") }}</strong>: ‚≠ê {{ r.rating }}/5 ‚Äî "{{ r.comment }}"
                                </p>
                                {% endfor %}
                            </div>
                        </div>

                        {% else %} {# Si no hay rese√±as, se indica con un mensaje #}
                        <p class="mt-3 subtitle-movie">Sin rese√±as a√∫n.</p>
                        {% endif %}

                        <!-- Parte inferior: bot√≥n para a√±adir la pel√≠cula o alerta si ya fue a√±adida -->
                        <div class="mt-auto">
                            {% if not movie.already_added %}
                            <a href="{{ url_for('explore.import_movie_date', movie_id=movie.id) }}"
                                class="btn btn-success btn-sm w-100 mt-3">
                                ‚ûï A√±adir a mis pel√≠culas
                            </a>
                            {% else %}
                            <div class="alert alert-success text-center p-2 mt-3 size-added" role="alert">
                                ‚úî ¬°Ya has a√±adido esta pel√≠cula!
                            </div>
                            {% endif %}
                        </div>

                    </div>
                </div>
            </div>

            {% endfor %}
        </div>

        {% else %} {# Si no hay pel√≠culas en la base de datos #}
        <p class="text-center mt-5">No hay pel√≠culas a√∫n en CineMate.</p>
        {% endif %}
    </div>
</div>

<!-- Bot√≥n fijo para volver al men√∫ principal -->
<a href="{{ url_for('main_routes.index') }}" class="btn btn-success position-fixed bottom-0 start-0 m-4">
    ‚Üê Volver a Men√∫ Principal
</a>

{% endblock %} {# Fin del bloque de contenido principal #}
